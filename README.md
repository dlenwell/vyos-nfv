# vyos-nfv

Packer, Vagrant scripts to transform VyOS rolling release into a ready to use image.

## Packer images and Vagrant boxes generation

### prerequisites

For building everything : a linux host with VM support with packer, virtualbox and QEMU/libvirt installed.

### rolling release aspects

We provide a python script to generate the latest VyOS rolling release building command : 
```
sudo apt-get install python-bs4 # dependency for the script
python vyos-latest.py
```

It will automatically run the correponsing packer command by overriding the latest URL and hash values. 

### outputs

We simultaneouly generate the QEMU/libvirt image: 
```
file build_qemu/vyos.img 
build_qemu/vyos.img: QEMU QCOW Image (v3), 17179869184 bytes
```
and the virtualbox image:
```
file build_virtualbox/vyos.ova 
build_virtualbox/vyos.ova: POSIX tar archive
```

### Vagrant based box

As well, after calling packer build, a vagrant-ready image will be made available in the main directory :
```
ls *.box
# vyos-libvirt.box
# vyos-virtualbox.box
```

Those boxes can be added to be ready to use with Vagrant:
```
vagrant box add vyos-libvirt.box --name vyos --force
vagrant box add vyos-virtualbox.box --name vyos --force
```

### Docker image

For various reason it might be interesting to run VyOS via QEMU running in a container. In that case adapt the docker-compose and the docker_run.sh script to the use case.

By default, I am doing a small NAT with the default docker container network so that the VyOS SSH prompt is accessible.

```
docker-compose build --no-cache
docker-compose up -d
ssh localhost -l vagrant -p 2222 # SSH access on eth0
```


## Building a router in a couple of lines of Vagrantfile

Using virtualbox provider (default one):
```
vagrant init vyos # this will generate an editable Vagrantfile with the vyos box
vagrant up 
vagrant ssh # to login in the final machine
```

Using libvirt provider:
```
wget https://releases.hashicorp.com/vagrant/2.2.3/vagrant_2.2.3_x86_64.deb
dpkg -i vagrant_2.2.3_x86_64.deb
sudo apt-get install libxslt-dev libxml2-dev libvirt-dev zlib1g-dev ruby-dev 
CONFIGURE_ARGS="with-libvirt-include=/usr/include/libvirt with-libvirt-lib=/usr/lib64" vagrant plugin install vagrant-libvirt
```

Then using the box file generated by packer:
```
vagrant init vyos # this will generate an editable Vagrantfile
vagrant up --provider=libvirt
vagrant ssh # to login in the final machine
```
## examples

I am providing some ready to use examples such as :
* [examples/home-router/Vagrantfile](examples/home-router/Vagrantfile) scenario : this will launch enable a computer with 2 interfaces to act as a home router with NAT, DNS, DHCP and firewall

## ssh provisioning

One can use the ssh provision of Vagrant to auto configure the VyOS image on vagrant up:
```
source /opt/vyatta/etc/functions/script-template
set service lldp
commit  
save  
chgrp -R vyattacfg /opt/vyatta/config/active/ # fixing permission in the active config
```

## Caveats and notes
Note that Vagrant is automatically replacing the insecure ssh key, so it would be wise to configure the new ssh key generated by vagrant (typically available in .vagrant/machines/default/libvirt/private_key) into VyOS using the following :
```
ssh-keygen -y -f .vagrant/machines/default/libvirt/private_key
# this will display the public key part. We just need the key itself : ssh-rsa AAAA.... 
vagrant ssh 
configure
set system login user vagrant authentication public-keys identifier key 'AAAA...'
commit
save
exit
```
