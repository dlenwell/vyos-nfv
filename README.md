# vyos-nfv
Tools to generate a cloud-ready VyOS image

## Packer-based QCOW2 image generator

We use a standard Ubuntu LTE (18.04) for this. First some dependencies :
```
wget https://releases.hashicorp.com/packer/1.3.3/packer_1.3.3_linux_amd64.zip # we fetch a recent packer from their website 
unzip packer_1.3.3_linux_amd64.zip && sudo mv packer /usr/local/bin # make the binary available to the system users
adduser $USER kvm # required for packer to use KVM as normal user
```

Adjust variables in vyos-var.json if necessary, or use the provided python script to generate the latest VyOS rolling release building command : 
```
sudo apt-get install python-bs4
python vyos-latest.py
#To build VyOS QCOW image: packer build -var-file=vyos-var.json -var 'iso_url=https://downloads.vyos.io/rolling/current/amd64/vyos-1.2.0-rolling%2B201905081347-amd64.iso' -var 'iso_checksum=58f358a09949ea97e539ce53ed1ac9b55296050d' vyos.qcow2.json
```

Output QCOW2 image should be available in the build/ directory :
```
ls build/
# vyos.img
```

## Vagrant based box

As well, after calling packer build, a vagrant-ready image will be made available in the main directory :
```
ls *.box
# vyos.box
```
Again, some dependencies, as we are building only the image for the libvirt provider. 

We need to install vagrant and the libvirt provider as a plugins. Unfortunately on Ubuntu LTE (18.04) to install the upstream version we need some tweaks to get installed at the time of this document :

```
wget https://releases.hashicorp.com/vagrant/2.2.3/vagrant_2.2.3_x86_64.deb
dpkg -i vagrant_2.2.3_x86_64.deb
sudo apt-get install libxslt-dev libxml2-dev libvirt-dev zlib1g-dev ruby-dev 
CONFIGURE_ARGS="with-libvirt-include=/usr/include/libvirt with-libvirt-lib=/usr/lib64" vagrant plugin install vagrant-libvirt
```

Then using the box file generated by packer:
```
vagrant box add vyos.box --name vyos
vagrant init vyos # this will generate an editable Vagrantfile
vagrant up --provider=libvirt
vagrant ssh # to login in the final machine
```

Note that Vagrant is automatically replacing the insecure ssh key, so it would be wise to configure the new ssh key generated by vagrant (typically available in .vagrant/machines/default/libvirt/private_key) into VyOS using the following :
```
ssh-keygen -y -f .vagrant/machines/default/libvirt/private_key
# this will display the public key part. We just need the key itself : ssh-rsa AAAA.... 
vagrant ssh 
configure
set system login user vagrant authentication public-keys identifier key 'AAAA...'
commit
save
exit
```
## ssh provisioning

One can use the ssh provision of Vagrant to auto configure the VyOS image on vagrant up:
```
/opt/vyatta/sbin/vyatta-cfg-cmd-wrapper begin
/opt/vyatta/sbin/vyatta-cfg-cmd-wrapper set service lldp
/opt/vyatta/sbin/vyatta-cfg-cmd-wrapper commit  
/opt/vyatta/sbin/vyatta-cfg-cmd-wrapper save  
/opt/vyatta/sbin/vyatta-cfg-cmd-wrapper end
```
